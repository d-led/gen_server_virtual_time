# Versioning & Release Guide

Complete guide to version management, release workflow, and publishing for
GenServerVirtualTime.

## Table of Contents

- [Version Scheme](#version-scheme)
- [Version Storage](#version-storage)
- [Bump Version Script](#bump-version-script)
- [Release Workflow](#release-workflow)
- [CI/CD Publishing](#cicd-publishing)
- [Version Propagation](#version-propagation)
- [Hex.pm Management](#hexpm-management)
- [Troubleshooting](#troubleshooting)

## Version Scheme

We follow [Semantic Versioning](https://semver.org/):

- **MAJOR.MINOR.PATCH** (e.g., `1.2.3`)
- **MAJOR.MINOR.PATCH-rc.N** (e.g., `1.2.3-rc.0`) for release candidates
- **MAJOR.MINOR.PATCH-beta.N** for beta releases
- **MAJOR.MINOR.PATCH-alpha.N** for alpha releases

Examples from Elixir itself:

- Stable: `v1.18.4`, `v1.18.3`, `v1.18.2`
- Release Candidates: `v1.19.0-rc.0`, `v1.19.0-rc.1`, `v1.19.0-rc.2`

## Version Storage

### Single Source of Truth

The **single source of truth** for the version is `mix.exs`:

```elixir
@version "0.2.1"
```

All other version references derive from this value through:

1. **Compile time** (Elixir code reads from `Mix.Project.config()[:version]`)
2. **Generation time** (generators use library version)
3. **Bump time** (script updates documentation files)

### Files That Reference Version

#### 1. Auto-Updated at Compile Time

**`lib/gen_server_virtual_time.ex`**

```elixir
def version, do: Mix.Project.config()[:version]
```

- Reads version from mix.exs at **compile time**
- No manual updates needed

**`lib/actor_simulation/pony_generator.ex`**

```elixir
defp generate_corral(project_name) do
  version = GenServerVirtualTime.version()
  # Uses version in generated corral.json
end
```

- Gets version from library at **generation time**
- Generated Pony projects will have current version

**`test/gen_server_virtual_time_test.exs`**

```elixir
test "returns version" do
  assert GenServerVirtualTime.version() == Mix.Project.config()[:version]
end
```

- Tests that version function returns correct value
- No hardcoded version strings

#### 2. Script-Updated Files

These files are updated by `scripts/bump_version.sh`:

- **`mix.exs`** - `@version` attribute
- **`README.md`** - Dependency example: `{:gen_server_virtual_time, "~> 0.2.1"}`
- **`CHANGELOG.md`** - Adds new version header with date
- **`generated/examples/index.html`** - Main landing page (if exists)
- **`generated/examples/reports/index.html`** - Reports landing page (if exists)

#### 3. Generated Files (Don't Edit Directly)

These files are regenerated by tests or scripts:

- `examples/pony_*/corral.json` - Generated by
  `mix run scripts/generate_pony_examples.exs`
- `generated/examples/*.html` - Generated by running tests
- `generated/*/` - Generated by scripts in `scripts/` directory

**Do not edit manually** - they will be overwritten.

## Bump Version Script

Use `scripts/bump_version.sh` to manage versions:

### Regular Version Bumps

```bash
# Patch version: 0.2.0 → 0.2.1
./scripts/bump_version.sh patch

# Minor version: 0.2.0 → 0.3.0
./scripts/bump_version.sh minor

# Major version: 0.2.0 → 1.0.0
./scripts/bump_version.sh major
```

### Release Candidate Workflow

**1. Create first RC:**

```bash
# From stable 0.2.0 → 0.2.1-rc.0
./scripts/bump_version.sh rc
```

**2. Iterate on RC:**

```bash
# From 0.2.1-rc.0 → 0.2.1-rc.1
./scripts/bump_version.sh rc

# From 0.2.1-rc.1 → 0.2.1-rc.2
./scripts/bump_version.sh rc
```

**3. Release stable from RC:**

```bash
# From 0.2.1-rc.2 → 0.2.1 (stable)
./scripts/bump_version.sh release
```

**Alternative: Skip RC and go to next version:**

```bash
# From 0.2.1-rc.0 → 0.3.0 (abandon RC, jump to minor)
./scripts/bump_version.sh minor
```

### What the Script Updates

The `bump_version.sh` script automatically updates:

1. `mix.exs` - `@version` attribute using sed
2. `README.md` - Dependency example using sed
3. `CHANGELOG.md` - Adds new version header with current date
4. `generated/examples/index.html` - Main examples landing page (if exists)
5. `generated/examples/reports/index.html` - Reports landing page (if exists)

## Release Workflow

### Complete Release Process

#### 1. Prepare Release

```bash
# Create RC or bump version
./scripts/bump_version.sh rc  # or: patch, minor, major

# Review changes
git diff

# Update CHANGELOG.md manually
# - Move unreleased items under new version
# - Add release notes
# - Mention breaking changes if any
```

#### 2. Update Code

```bash
# Recompile to pick up new version
mix compile

# Run all tests
mix test

# Run quality checks
mix precommit  # Runs format, credo, dialyzer
```

#### 3. Regenerate Examples (Optional but Recommended)

```bash
mix run scripts/generate_pony_examples.exs
mix run scripts/generate_caf_examples.exs
# etc.
```

#### 4. Commit and Tag

```bash
# Commit changes
git add -A
git commit -m "Release v0.2.1-rc.0"

# Create tag
git tag v0.2.1-rc.0

# Push (this triggers CI/CD)
git push && git push --tags
```

## CI/CD Publishing

### Automated Publishing Workflow

**File:** `.github/workflows/publish.yml`

**Triggers:** Push tag matching:

- `v*.*.*` (e.g., `v0.2.1`)
- `v*.*.*-rc.*` (e.g., `v0.2.1-rc.0`)
- `v*.*.*-beta.*` (e.g., `v0.3.0-beta.1`)
- `v*.*.*-alpha.*` (e.g., `v0.4.0-alpha.1`)

**Environment:**

- Elixir: 1.18
- OTP: 27
- MIX_ENV: prod

**Steps:**

1. ✅ Checkout code
2. ✅ Setup Elixir/OTP
3. ✅ Cache dependencies (`deps/`, `_build/`)
4. ✅ Install dependencies (`mix deps.get`)
5. ✅ Compile project (`mix compile`)
6. ✅ Run tests (`mix test`)
7. ✅ Build documentation (`mix docs`)
8. ✅ Publish to Hex.pm (requires `HEX_API_KEY` secret)
9. ✅ Create GitHub Release with auto-generated notes

**Pre-release Detection:**

Tags containing `-rc.`, `-beta.`, or `-alpha.` are automatically marked as
pre-releases on GitHub.

### Pre-release vs Stable

**Pre-release tags** (with `-rc.`, `-beta.`, `-alpha.`):

- Published to Hex.pm as pre-release
- Marked as "Pre-release" on GitHub
- Can be installed with: `{:gen_server_virtual_time, "~> 0.2.1-rc.0"}`

**Stable tags** (no suffix):

- Published to Hex.pm as stable
- Full GitHub Release
- Default installation: `{:gen_server_virtual_time, "~> 0.2.0"}`

## Version Propagation

### Design Principles

1. **Single Source of Truth**: Version only defined in `mix.exs`
2. **Compile-Time Derivation**: Elixir code reads from
   `Mix.Project.config()[:version]`
3. **Generation-Time Derivation**: Generators use library version via
   `GenServerVirtualTime.version()`
4. **Don't Edit Generated Files**: They're regenerated from source
5. **Script for Manual Files**: `bump_version.sh` updates documentation

### Verification Commands

To verify all versions are consistent:

```bash
# Check mix.exs version
grep '@version' mix.exs

# Check library returns correct version
mix run -e "IO.puts(GenServerVirtualTime.version())"

# Check README version
grep 'gen_server_virtual_time' README.md

# Check generated Pony projects
cat examples/pony_loadbalanced/corral.json | grep version

# Run tests (includes version test)
mix test
```

All should show the same version number.

## Hex.pm Management

### Version Lifecycle

**Can you delete versions?**

From Hex.pm:

- ⚠️ **Packages can be retired but NOT deleted** after 1 hour
- Use `mix hex.retire` to mark a version as retired
- Retired versions show a warning but remain installable

From HexDocs:

- ❌ Documentation versions **cannot be deleted** once published
- Old versions remain accessible at
  `https://hexdocs.pm/gen_server_virtual_time/0.2.0`

### Retiring a Version

If you need to retire a problematic version:

```bash
# Retire a specific version
mix hex.retire gen_server_virtual_time 0.2.1-rc.0 --reason security

# Un-retire
mix hex.retire gen_server_virtual_time 0.2.1-rc.0 --unretire
```

**Retirement reasons:**

- `security` - Security issue
- `deprecated` - Deprecated in favor of newer version
- `invalid` - Published by mistake
- `other` - Other reason (provide message)

### Best Practices

- Don't publish broken RC versions if possible
- Test thoroughly before tagging
- Use RC versions for testing, stable for production
- If an RC is broken, skip to the next RC number

## Version Support Policy

- **Latest stable**: Full support, bug fixes, new features
- **Previous minor**: Security fixes only
- **Older versions**: No support (users should upgrade)

## Breaking Changes

When introducing breaking changes:

1. Bump **MAJOR** version (e.g., `0.2.0` → `1.0.0`)
2. Document breaking changes in CHANGELOG under "Breaking Changes" section
3. Provide migration guide if needed
4. Consider deprecation warnings in previous version first

## Example Release Workflow

**Scenario: Release 0.3.0 with RC testing**

```bash
# 1. Create first RC
./scripts/bump_version.sh rc
# Version: 0.2.0 → 0.3.0-rc.0

# 2. Update CHANGELOG.md
# Add release notes under [0.3.0-rc.0]

# 3. Test and compile
mix compile
mix test
mix precommit

# 4. Commit and tag
git add -A
git commit -m "Release v0.3.0-rc.0"
git tag v0.3.0-rc.0
git push && git push --tags

# 5. Wait for CI, test the RC in staging

# 6. If issues found, fix and create RC.1
./scripts/bump_version.sh rc
# Version: 0.3.0-rc.0 → 0.3.0-rc.1
git add -A
git commit -m "Release v0.3.0-rc.1"
git tag v0.3.0-rc.1
git push && git push --tags

# 7. When RC is stable, release
./scripts/bump_version.sh release
# Version: 0.3.0-rc.1 → 0.3.0

# 8. Final commit and tag
git add -A
git commit -m "Release v0.3.0"
git tag v0.3.0
git push && git push --tags
```

## Troubleshooting

### Version mismatch error

If Hex complains about version mismatch:

```bash
# Check mix.exs version matches tag
grep '@version' mix.exs
# Should show: @version "0.2.1"

# Ensure tag matches
git describe --tags
# Should show: v0.2.1
```

### CI fails on publish

Check:

- `HEX_API_KEY` secret is set in GitHub repository settings
- Tests pass locally: `mix test`
- Version in `mix.exs` matches the tag
- All quality checks pass: `mix precommit`

### Want to test publish workflow locally

Use `mix hex.build` to test package building:

```bash
mix hex.build
# Creates gen_server_virtual_time-0.2.0.tar

# Inspect contents
tar -tzf gen_server_virtual_time-0.2.0.tar
```

### Version not updating in library

If `GenServerVirtualTime.version()` returns old version:

```bash
# Clean and recompile
mix clean
mix compile

# Verify
mix run -e "IO.puts(GenServerVirtualTime.version())"
```

## Testing Before Release

Before tagging, ensure all checks pass:

```bash
# All tests pass
mix test

# No compilation warnings
mix compile --warnings-as-errors

# Formatting is correct
mix format --check-formatted

# Credo is clean
mix credo --strict

# Dialyzer is happy
mix dialyzer
```

Or use the pre-commit task:

```bash
mix precommit
```

## References

- [Semantic Versioning](https://semver.org/)
- [Hex.pm Publishing Guide](https://hex.pm/docs/publish)
- [Elixir Release Process](https://github.com/elixir-lang/elixir/tags)
- [Keep a Changelog](https://keepachangelog.com/)
- [GitHub Actions Documentation](https://docs.github.com/en/actions)

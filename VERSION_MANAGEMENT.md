# Version Management

## Overview

This document describes how version numbers are managed across the project, ensuring consistency and automatic propagation when versions are bumped.

## Version Sources

The **single source of truth** for the version is `mix.exs`:

```elixir
@version "0.2.1-rc.0"
```

All other version references derive from this value, either:
1. **At compile time** (Elixir code)
2. **At generation time** (generated files)
3. **At bump time** (documentation)

## Files That Reference Version

### 1. Source Files (Auto-Updated)

These files automatically get the correct version from `mix.exs`:

#### `lib/gen_server_virtual_time.ex`
```elixir
def version, do: Mix.Project.config()[:version]
```
- Reads version from mix.exs at **compile time**
- No manual updates needed

#### `lib/actor_simulation/pony_generator.ex`
```elixir
defp generate_corral(project_name) do
  version = GenServerVirtualTime.version()
  # Uses version in generated corral.json
end
```
- Gets version from library at **generation time**
- Generated Pony projects will have current version

#### `test/gen_server_virtual_time_test.exs`
```elixir
test "returns version" do
  assert GenServerVirtualTime.version() == Mix.Project.config()[:version]
end
```
- Tests that version function returns correct value
- No hardcoded version strings

### 2. Documentation Files (Script-Updated)

These files are updated by `scripts/bump_version.sh`:

#### `README.md`
```elixir
{:gen_server_virtual_time, "~> 0.2.1-rc.0"}
```
- Updated by bump_version.sh using sed
- Shows users what version to install

#### `CHANGELOG.md`
- Automatically adds new version header
- Updated by bump_version.sh

#### `generated/examples/index.html`
```elixir
{:gen_server_virtual_time, "~> 0.2.1-rc.0"}
```
- Main landing page for GitHub Pages examples
- Updated by bump_version.sh using sed

#### `generated/examples/reports/index.html`
```elixir
{:gen_server_virtual_time, "~> 0.2.1-rc.0"}
```
- Reports landing page for GitHub Pages
- Updated by bump_version.sh using sed

### 3. Generated Files (Don't Edit Directly)

These files are generated by tests or scripts:

#### `examples/pony_*/corral.json`
- Generated by running `mix run scripts/generate_pony_examples.exs`
- Uses version from `PonyGenerator.generate_corral/1`
- **Do not edit manually**

#### `generated/examples/*.html`
- Generated by running tests
- **Do not edit manually**

#### `generated/pony_*/`, `generated/caf_*/`, etc.
- Generated by scripts in `scripts/` directory
- **Do not edit manually**

## Bumping Versions

### Using the Script

```bash
# Patch: 0.2.0 -> 0.2.1
./scripts/bump_version.sh patch

# Minor: 0.2.0 -> 0.3.0
./scripts/bump_version.sh minor

# Major: 0.2.0 -> 1.0.0
./scripts/bump_version.sh major

# Release candidate: 0.2.0 -> 0.2.1-rc.0
./scripts/bump_version.sh rc

# Release from RC: 0.2.1-rc.0 -> 0.2.1
./scripts/bump_version.sh release
```

### What the Script Updates

The `bump_version.sh` script automatically updates:

1. **mix.exs** - `@version` attribute
2. **README.md** - Dependency example
3. **CHANGELOG.md** - Adds new version header
4. **generated/examples/index.html** - Main examples landing page (if exists)
5. **generated/examples/reports/index.html** - Reports landing page (if exists)

### What Updates Automatically

After running the script and recompiling:

1. **lib/gen_server_virtual_time.ex** - Reads from mix.exs at compile time
2. **Generated files** - Regenerated by running:
   ```bash
   mix test  # Regenerates test output files
   mix run scripts/generate_pony_examples.exs
   mix run scripts/generate_caf_examples.exs
   # etc.
   ```

### What Stays the Same

Documentation files in `docs/` that show version ranges:
```elixir
Mix.install([{:gen_server_virtual_time, "~> 0.2.0"}])
```

These use major.minor versions without patch/rc and are fine as-is since they show compatible version ranges.

## Complete Bump Process

```bash
# 1. Bump the version
./scripts/bump_version.sh minor  # or patch, major, rc, release

# 2. Review the changes
git diff

# 3. Update CHANGELOG.md with release notes (manual step)
# Edit CHANGELOG.md to add release notes under the new version

# 4. Recompile to pick up new version
mix compile

# 5. Regenerate examples (optional, recommended)
mix test
mix run scripts/generate_pony_examples.exs
mix run scripts/generate_caf_examples.exs
# etc.

# 6. Commit
git add -A
git commit -m "Release v0.3.0"

# 7. Tag
git tag v0.3.0

# 8. Push
git push && git push --tags
```

## Design Principles

1. **Single Source of Truth**: Version only defined in `mix.exs`
2. **Compile-Time Derivation**: Elixir code reads from mix.exs
3. **Generation-Time Derivation**: Generators use library version
4. **Don't Edit Generated Files**: They're regenerated from source
5. **Script for Manual Files**: bump_version.sh updates docs

## Verification

To verify all versions are consistent:

```bash
# Check mix.exs version
grep '@version' mix.exs

# Check library returns correct version
mix run -e "IO.puts(GenServerVirtualTime.version())"

# Check README version
grep 'gen_server_virtual_time' README.md

# Check generated Pony projects
cat examples/pony_loadbalanced/corral.json | grep version

# Run tests
mix test
```

All should show the same version number.

